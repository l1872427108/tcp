# TCP 快速打开原理 （TFO）


TCP 的三次握手时很麻烦的，如果每次都需要进行建立三次握手。能不能优化呢？

这个优化手段，就是 TCP 快速打开（TFO）的原理.

我们可以借助 SYN Flood 攻击时提到的 SYN Cookie。

## TFO 流程
首轮三次握手:
首先客户端发送 SYN 给服务端，服务端接收到。

服务端不是直接回复 SYN + ACK , 而是通过计算一个 SYN Cookie，将这个 Cookie 放到 TCP 报文的 Fast Open 选项中，然后才返回给客户端。

客户端拿到这个 Cookie 的值缓存下来，后面正常完成三次握手。

首轮三次握手没有什么不一样的，不一样的是之后的握手.


### 之后的三次握手
之后的三次握手中，客户端会将之前缓存的 Cookie、SYN 和 HTTP 请求发送给服务端，服务端严重 Cookie 的合法性，如果不合法直接丢弃；如果是合法的，那么就正常返回 SYN + ACK。

现在服务端能够发 HTTP 响应了。三次握手虽然还没有建立，仅仅验证了 Cookie 的合法性，就可以返回 HTTP 响应了。



客户端的 ACK 还是需要正常传回的，只是这个 ACK 不一定要等到服务端的 HTTP 响应到达才发送，两个过程没有任何关系。


## TFO 优势
TFO 的优势不是在于首轮的三次握手，而是在于后面的握手，在拿到 Cookie 并通过以后，可以直接返回 HTTP 响应，可以充分利用 1 个 RTT（往返时间）的时间提前进行数据传输，积累起来是一个较大的优势。


